<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>–í–æ–∑—Ä–æ–∂–¥–µ–Ω–∏–µ –õ–µ—Å–∞</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap');

    :root {
      --primary: #4effbf;
    }

    body {
      margin: 0;
      overflow: hidden;
      background: #000;
      font-family: 'Montserrat', sans-serif;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }

    canvas {
      display: block;
      width: 100%;
      height: 100%;
    }

    /* –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å */
    #ui {
      position: absolute;
      top: 0; left: 0; width: 100%; height: 100%;
      pointer-events: none;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      padding: 20px;
      box-sizing: border-box;
      transition: opacity 0.5s;
    }

    .bar-container {
      width: 100%;
      max-width: 400px;
      margin: 0 auto;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
      padding: 10px 20px;
      border-radius: 30px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .bar-label {
      color: #fff;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 2px;
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
    }

    .progress-track {
      height: 8px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
      overflow: hidden;
      position: relative;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #ff6b6b, #ffd93d, #4effbf);
      width: 0%; /* –ú–µ–Ω—è–µ—Ç—Å—è JS-–æ–º */
      transition: width 0.5s cubic-bezier(0.25, 1, 0.5, 1);
      box-shadow: 0 0 10px rgba(78, 255, 191, 0.5);
    }

    /* –°—Ç–∞—Ä—Ç–æ–≤—ã–π —ç–∫—Ä–∞–Ω */
    .screen {
      position: absolute;
      inset: 0;
      background: rgba(14, 18, 26, 0.85);
      backdrop-filter: blur(15px);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 10;
      transition: opacity 0.8s, visibility 0.8s;
      pointer-events: auto;
    }
    .screen.hidden {
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
    }

    h1 {
      font-size: clamp(30px, 5vw, 60px);
      color: #fff;
      margin: 0 0 20px 0;
      text-align: center;
      line-height: 1.1;
      background: linear-gradient(135deg, #fff 0%, #a5b4fc 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    p {
      color: #94a3b8;
      max-width: 400px;
      text-align: center;
      line-height: 1.6;
      margin-bottom: 40px;
    }

    .btn {
      background: #fff;
      color: #000;
      border: none;
      padding: 16px 48px;
      font-size: 16px;
      font-weight: 700;
      border-radius: 100px;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      box-shadow: 0 0 30px rgba(255, 255, 255, 0.2);
    }
    .btn:hover { transform: scale(1.05); }
    .btn:active { transform: scale(0.95); }

    /* –í—Å–ø–ª—ã–≤–∞—é—â–∏–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏ */
    .float-text {
      position: absolute;
      color: #fff;
      font-weight: 700;
      pointer-events: none;
      animation: floatUp 1s forwards;
      text-shadow: 0 2px 4px rgba(0,0,0,0.5);
      z-index: 5;
    }
    @keyframes floatUp {
      0% { transform: translateY(0) scale(0.8); opacity: 1; }
      100% { transform: translateY(-50px) scale(1.2); opacity: 0; }
    }

    /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∫–ª–∏–∫–∞ */
    .cursor-glow {
      position: fixed;
      width: 40px; height: 40px;
      border-radius: 50%;
      border: 2px solid rgba(255,255,255,0.5);
      transform: translate(-50%, -50%);
      pointer-events: none;
      transition: transform 0.1s;
      z-index: 100;
      display: none;
    }
    @media (hover: hover) { .cursor-glow { display: block; } }

  </style>
</head>
<body>

  <canvas id="canvas"></canvas>
  <div class="cursor-glow" id="cursor"></div>

  <div id="ui">
    <div style="flex:1"></div> <div class="bar-container">
      <div class="bar-label">
        <span>–ß–∏—Å—Ç–æ—Ç–∞ –ø—Ä–∏—Ä–æ–¥—ã</span>
        <span id="percent">0%</span>
      </div>
      <div class="progress-track">
        <div class="progress-fill" id="fill"></div>
      </div>
    </div>
  </div>

  <div class="screen" id="startScreen">
    <h1>–í–æ–∑—Ä–æ–∂–¥–µ–Ω–∏–µ</h1>
    <p>–õ–µ—Å –ø–æ–ª–æ–Ω –º—É—Å–æ—Ä–∞, –ø—Ç–∏—Ü—ã —É–ª–µ—Ç–µ–ª–∏, –∞ –Ω–µ–±–æ —Å—Ç–∞–ª–æ —Å–µ—Ä—ã–º. <br>–ö–ª–∏–∫–∞–π –Ω–∞ –º—É—Å–æ—Ä, —á—Ç–æ–±—ã –æ—á–∏—Å—Ç–∏—Ç—å –ø—Ä–∏—Ä–æ–¥—É –∏ –≤–µ—Ä–Ω—É—Ç—å –∂–∏–∑–Ω—å.</p>
    <button class="btn" onclick="Game.start()">–ù–∞—á–∞—Ç—å —É–±–æ—Ä–∫—É</button>
  </div>

  <div class="screen hidden" id="endScreen">
    <h1>–ü—Ä–∏—Ä–æ–¥–∞ —Å–ø–∞—Å–µ–Ω–∞!</h1>
    <p>–ë–ª–∞–≥–æ–¥–∞—Ä—è —Ç–µ–±–µ –ª–µ—Å —Å–Ω–æ–≤–∞ –¥—ã—à–∏—Ç. –°–ª—ã—à–∏—à—å, –∫–∞–∫ –ø–æ—é—Ç –ø—Ç–∏—Ü—ã?</p>
    <button class="btn" onclick="Game.restart()">–°—ã–≥—Ä–∞—Ç—å –µ—â—ë —Ä–∞–∑</button>
  </div>

<script>
/**
 * AUDIO SYNTH (–ó–≤—É–∫–æ–≤–æ–π –¥–≤–∏–∂–æ–∫)
 * –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∑–≤—É–∫–∏ "–Ω–∞ –ª–µ—Ç—É", —á—Ç–æ–±—ã –Ω–µ –≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª—ã.
 */
const AudioSys = {
  ctx: null,
  masterGain: null,
  
  init() {
    const AC = window.AudioContext || window.webkitAudioContext;
    if (!AC) return;
    this.ctx = new AC();
    this.masterGain = this.ctx.createGain();
    this.masterGain.gain.value = 0.3;
    this.masterGain.connect(this.ctx.destination);
    this.startAmbience();
  },

  playTone(freq, type, dur, vol = 1) {
    if (!this.ctx) return;
    const osc = this.ctx.createOscillator();
    const g = this.ctx.createGain();
    osc.type = type;
    osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
    osc.frequency.exponentialRampToValueAtTime(freq * 0.5, this.ctx.currentTime + dur);
    
    g.gain.setValueAtTime(vol, this.ctx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + dur);
    
    osc.connect(g);
    g.connect(this.masterGain);
    osc.start();
    osc.stop(this.ctx.currentTime + dur);
  },

  trashSound() {
    // –ó–≤—É–∫ "—Å–º–∏–Ω–∞–Ω–∏—è" –º—É—Å–æ—Ä–∞
    this.playTone(200 + Math.random()*100, 'sawtooth', 0.1, 0.5);
    this.playTone(100, 'square', 0.15, 0.3);
  },

  natureSound() {
    // –ü—Ä–∏—è—Ç–Ω—ã–π "–¥–∑—ã–Ω—å"
    this.playTone(800 + Math.random()*400, 'sine', 1.5, 0.2);
  },

  startAmbience() {
    // –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Ñ–æ–Ω–æ–≤–æ–≥–æ —à—É–º–∞ (–≤–µ—Ç–µ—Ä -> –ø–µ–Ω–∏–µ –ø—Ç–∏—Ü)
    // –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ —É–ø—Ä–æ—â–µ–Ω–Ω–æ —á–µ—Ä–µ–∑ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –≤ GameLoop
  }
};

/**
 * GRAPHICS & LOGIC
 */
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d', { alpha: false });
let W, H, DPR;

const ANIMALS_POOL = ['ü¶å', 'ü¶ä', 'üêá', 'ü¶Ü', 'ü¶â', 'ü¶ã', 'üê¶', 'üêøÔ∏è'];
const TRASH_POOL = ['ü•°', 'ü•§', 'üß¥', 'ü•´', 'üì¶', 'üóûÔ∏è', 'üö¨', 'üõ¢Ô∏è'];

// –°–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã
const State = {
  pollution: 1.0, // 1.0 = –≥—Ä—è–∑–Ω–æ, 0.0 = —á–∏—Å—Ç–æ
  trashItems: [],
  animals: [],
  particles: [],
  clouds: [],
  targetPollution: 1.0,
  playing: false
};

// --- –ö–õ–ê–°–°–´ ---

class Trash {
  constructor() {
    this.x = Math.random() * W;
    // –†–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ–º –º—É—Å–æ—Ä –ø–æ "–∑–µ–º–ª–µ" (–Ω–∏–∂–Ω—è—è —Ç—Ä–µ—Ç—å —ç–∫—Ä–∞–Ω–∞)
    this.y = H * 0.65 + Math.random() * (H * 0.3); 
    this.size = 30 + Math.random() * 20;
    this.type = TRASH_POOL[Math.floor(Math.random() * TRASH_POOL.length)];
    this.rotation = (Math.random() - 0.5);
    this.hover = false;
    this.scale = 0;
    this.targetScale = 1;
  }

  draw(dt) {
    // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è
    this.scale += (this.targetScale - this.scale) * 5 * dt;
    
    ctx.save();
    ctx.translate(this.x, this.y);
    ctx.rotate(this.rotation);
    ctx.scale(this.scale * (this.hover ? 1.2 : 1), this.scale * (this.hover ? 1.2 : 1));
    
    ctx.font = `${this.size}px serif`;
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    
    // –¢–µ–Ω—å
    ctx.fillStyle = 'rgba(0,0,0,0.3)';
    ctx.fillText(this.type, 2, 5);
    
    // –°–∞–º –ø—Ä–µ–¥–º–µ—Ç (–Ω–µ–º–Ω–æ–≥–æ —Å–µ—Ä—ã–π –µ—Å–ª–∏ –≥—Ä—è–∑–Ω–æ)
    ctx.filter = `grayscale(${State.pollution * 80}%) brightness(${1 - State.pollution*0.3})`;
    ctx.fillText(this.type, 0, 0);
    ctx.filter = 'none';

    ctx.restore();
  }

  checkHit(mx, my) {
    const d = Math.hypot(mx - this.x, my - this.y);
    return d < this.size;
  }
}

class Animal {
  constructor() {
    this.type = ANIMALS_POOL[Math.floor(Math.random() * ANIMALS_POOL.length)];
    this.x = Math.random() > 0.5 ? -50 : W + 50; // –°–ø–∞–≤–Ω –∑–∞ —ç–∫—Ä–∞–Ω–æ–º
    this.y = H * 0.6 + Math.random() * (H * 0.25);
    
    // –ü—Ç–∏—Ü—ã –≤—ã—à–µ
    if (['ü¶â', 'üê¶', 'ü¶ã', 'ü¶Ü'].includes(this.type)) {
      this.y = H * 0.1 + Math.random() * (H * 0.4);
      this.floating = true;
    }

    this.dir = this.x < 0 ? 1 : -1; // –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–≤–∏–∂–µ–Ω–∏—è
    this.speed = (20 + Math.random() * 40) * (this.floating ? 1.5 : 1);
    this.size = 0;
    this.targetSize = 40 + Math.random() * 20;
    this.time = Math.random() * 10;
  }

  update(dt) {
    this.size += (this.targetSize - this.size) * 3 * dt;
    this.x += this.speed * this.dir * dt;
    this.time += dt;

    if (this.floating) {
      this.y += Math.sin(this.time * 3) * 0.5;
    } else {
      // –ü—Ä—ã–∂–∫–∏ –¥–ª—è –Ω–∞–∑–µ–º–Ω—ã—Ö
      this.y += Math.sin(this.time * 10) * 0.3;
    }
  }

  draw() {
    ctx.save();
    ctx.translate(this.x, this.y);
    ctx.scale(this.dir * -1, 1); // –†–∞–∑–≤–æ—Ä–æ—Ç –∫–∞—Ä—Ç–∏–Ω–∫–∏
    ctx.scale(this.size / 40, this.size / 40);
    
    // –°–≤–µ—á–µ–Ω–∏–µ –¥–ª—è –º–∞–≥–∏—á–µ—Å–∫–∏—Ö –∂–∏–≤–æ—Ç–Ω—ã—Ö
    if (State.pollution < 0.2) {
      ctx.shadowColor = '#fff';
      ctx.shadowBlur = 15;
    }
    
    ctx.font = '40px serif';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText(this.type, 0, 0);
    
    ctx.restore();
  }
}

class Particle {
  constructor(x, y, color) {
    this.x = x; this.y = y;
    this.color = color;
    this.vx = (Math.random() - 0.5) * 200;
    this.vy = (Math.random() - 1) * 200;
    this.life = 1.0;
    this.decay = 0.5 + Math.random();
  }
  update(dt) {
    this.x += this.vx * dt;
    this.y += this.vy * dt;
    this.life -= this.decay * dt;
  }
  draw() {
    ctx.globalAlpha = Math.max(0, this.life);
    ctx.fillStyle = this.color;
    ctx.beginPath();
    ctx.arc(this.x, this.y, 4, 0, Math.PI*2);
    ctx.fill();
    ctx.globalAlpha = 1.0;
  }
}

// --- –û–¢–†–ò–°–û–í–ö–ê –ú–ò–†–ê ---

function drawSky(p) {
  // p = pollution (1 = –≥—Ä—è–∑–Ω–æ, 0 = —á–∏—Å—Ç–æ)
  
  // –ò–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—è —Ü–≤–µ—Ç–æ–≤ –Ω–µ–±–∞
  // –ì—Ä—è–∑–Ω–æ: #3f3f3f -> #1a1a1a
  // –ß–∏—Å—Ç–æ:  #4fa8ff -> #b0e0ff (–î–µ–Ω—å) –∏–ª–∏ –ó–∞–∫–∞—Ç
  
  const r1 = 63 * p + 79 * (1-p); 
  const g1 = 63 * p + 168 * (1-p);
  const b1 = 63 * p + 255 * (1-p);
  
  const r2 = 26 * p + 176 * (1-p);
  const g2 = 26 * p + 224 * (1-p);
  const b2 = 26 * p + 255 * (1-p);

  const grad = ctx.createLinearGradient(0, 0, 0, H);
  grad.addColorStop(0, `rgb(${r1},${g1},${b1})`);
  grad.addColorStop(1, `rgb(${r2},${g2},${b2})`);
  
  ctx.fillStyle = grad;
  ctx.fillRect(0,0,W,H);

  // –°–æ–ª–Ω—Ü–µ
  const sunY = H * 0.2 + (p * 50); // –°–æ–ª–Ω—Ü–µ –ø–æ–¥–Ω–∏–º–∞–µ—Ç—Å—è –∫–æ–≥–¥–∞ —á–∏—Å—Ç–æ
  ctx.save();
  ctx.translate(W * 0.7, sunY);
  
  // –õ—É—á–∏ (God Rays) - –≤–∏–¥–Ω—ã —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ —á–∏—Å—Ç–æ
  if (p < 0.6) {
    ctx.globalAlpha = (1 - p) * 0.4;
    for (let i = 0; i < 8; i++) {
      ctx.beginPath();
      ctx.rotate(Date.now() * 0.0001);
      ctx.moveTo(0, 0);
      ctx.lineTo(W, 100);
      ctx.lineTo(W, -100);
      const gradRay = ctx.createRadialGradient(0,0,10, 0,0,W);
      gradRay.addColorStop(0, 'rgba(255,255,200,0.5)');
      gradRay.addColorStop(1, 'rgba(255,255,200,0)');
      ctx.fillStyle = gradRay;
      ctx.fill();
    }
    ctx.globalAlpha = 1;
  }
  
  // –°–∞–º –¥–∏—Å–∫
  const sunColor = p > 0.5 ? '#888' : '#fff'; // –°–µ—Ä–æ–µ —Å–æ–ª–Ω—Ü–µ –≤ —Å–º–æ–≥–µ
  const sunGlow = p > 0.5 ? 0 : 50 * (1-p);
  ctx.shadowColor = '#ffd700';
  ctx.shadowBlur = sunGlow;
  ctx.fillStyle = sunColor;
  ctx.beginPath();
  ctx.arc(0,0, 40, 0, Math.PI*2);
  ctx.fill();
  ctx.shadowBlur = 0;
  ctx.restore();
}

function drawLandscape(p) {
  // –ó–µ–º–ª—è / –¢—Ä–∞–≤–∞
  // –¶–≤–µ—Ç –∑–µ–º–ª–∏: –ö–æ—Ä–∏—á–Ω–µ–≤—ã–π —Å–µ—Ä—ã–π -> –°–æ—á–Ω—ã–π –∑–µ–ª–µ–Ω—ã–π
  const r = 50 * p + 34 * (1-p);
  const g = 40 * p + 160 * (1-p);
  const b = 30 * p + 70 * (1-p);
  
  ctx.fillStyle = `rgb(${r},${g},${b})`;
  
  // –†–∏—Å—É–µ–º —Ö–æ–ª–º—ã –∫—Ä–∏–≤—ã–º–∏ –ë–µ–∑—å–µ
  ctx.beginPath();
  ctx.moveTo(0, H);
  ctx.lineTo(0, H * 0.6);
  ctx.bezierCurveTo(W*0.3, H*0.55, W*0.6, H*0.65, W, H*0.6);
  ctx.lineTo(W, H);
  ctx.fill();

  // –î–µ—Ä–µ–≤—å—è (–ø—Ä–æ—Ü–µ–¥—É—Ä–Ω—ã–µ —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫–∏)
  // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–µ—Ä–µ–≤—å–µ–≤ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–æ, –Ω–æ —Ü–≤–µ—Ç –º–µ–Ω—è–µ—Ç—Å—è
  const treeColor = p > 0.5 ? '#1a1510' : '#0b4d28';
  ctx.fillStyle = treeColor;
  
  // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Å–µ–≤–¥–æ-—Å–ª—É—á–∞–π–Ω–æ—Å—Ç—å, —á—Ç–æ–±—ã –¥–µ—Ä–µ–≤—å—è –Ω–µ "–ø—Ä—ã–≥–∞–ª–∏"
  let seed = 123;
  const pseudoRandom = () => { seed = (seed * 9301 + 49297) % 233280; return seed / 233280; };
  
  for(let i=0; i<15; i++) {
    const tx = pseudoRandom() * W;
    const ty = H * 0.6 + pseudoRandom() * 50;
    const tw = 20 + pseudoRandom() * 30;
    const th = 40 + pseudoRandom() * 80;
    
    // –°—Ç–≤–æ–ª
    ctx.fillStyle = '#3e2723';
    ctx.fillRect(tx-tw/6, ty, tw/3, th/4);
    
    // –ö—Ä–æ–Ω–∞
    ctx.fillStyle = treeColor;
    if (p < 0.3 && i % 3 === 0) ctx.fillStyle = '#146b3a'; // –†–∞–∑–Ω–æ—Ç–æ–Ω–Ω–æ—Å—Ç—å
    
    ctx.beginPath();
    ctx.moveTo(tx - tw/2, ty);
    ctx.lineTo(tx, ty - th);
    ctx.lineTo(tx + tw/2, ty);
    ctx.fill();
  }
}

// --- GAME LOOP ---

let lastTime = 0;
function loop(time) {
  const dt = (time - lastTime) / 1000;
  lastTime = time;

  // –ü–ª–∞–≤–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –∑–∞–≥—Ä—è–∑–Ω–µ–Ω–∏—è
  State.pollution += (State.targetPollution - State.pollution) * 2 * dt;

  // 1. –†–∏—Å—É–µ–º –º–∏—Ä
  drawSky(State.pollution);
  drawLandscape(State.pollution);

  // 2. –¢—É–º–∞–Ω (–µ—Å–ª–∏ –≥—Ä—è–∑–Ω–æ)
  if (State.pollution > 0.1) {
    ctx.fillStyle = `rgba(100, 100, 100, ${State.pollution * 0.4})`;
    ctx.fillRect(0,0,W,H);
  }

  // 3. –û–±—ä–µ–∫—Ç—ã (—Å–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ Y –¥–ª—è –≥–ª—É–±–∏–Ω—ã)
  // ... –∂–∏–≤–æ—Ç–Ω—ã–µ
  State.animals.forEach(anim => {
    anim.update(dt);
    anim.draw();
  });
  // –£–¥–∞–ª—è–µ–º —É—à–µ–¥—à–∏—Ö –∂–∏–≤–æ—Ç–Ω—ã—Ö
  State.animals = State.animals.filter(a => a.x > -100 && a.x < W + 100);

  // ... –º—É—Å–æ—Ä
  State.trashItems.forEach(t => t.draw(dt));

  // ... —á–∞—Å—Ç–∏—Ü—ã
  State.particles.forEach((p, i) => {
    p.update(dt);
    p.draw();
    if(p.life <= 0) State.particles.splice(i, 1);
  });

  // 4. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∂–∏–≤–æ—Ç–Ω—ã—Ö
  if (State.playing && State.animals.length < 5) {
    // –ß–µ–º —á–∏—â–µ, —Ç–µ–º —á–∞—â–µ —Å–ø–∞–≤–Ω
    const chance = 0.01 + (1 - State.pollution) * 0.05;
    if (Math.random() < chance) {
      State.animals.push(new Animal());
    }
  }
  
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ü–∞ –∏–≥—Ä—ã
  if (State.playing && State.trashItems.length === 0 && State.pollution < 0.05) {
    endGame();
  }

  requestAnimationFrame(loop);
}

// --- LOGIC ---

const Game = {
  start() {
    AudioSys.init();
    State.playing = true;
    State.trashItems = [];
    State.animals = [];
    State.particles = [];
    State.pollution = 1.0;
    State.targetPollution = 1.0;
    
    // –°–ø–∞–≤–Ω–∏–º –º—É—Å–æ—Ä (–º–Ω–æ–≥–æ)
    for(let i=0; i<30; i++) {
      State.trashItems.push(new Trash());
    }

    document.getElementById('startScreen').classList.add('hidden');
    document.getElementById('endScreen').classList.add('hidden');
    document.getElementById('ui').style.opacity = 1;
    
    updateUI();
  },

  restart() {
    this.start();
  },

  onClick(x, y) {
    if (!State.playing) return;
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–ª–∏–∫–∞ –ø–æ –º—É—Å–æ—Ä—É
    let hitIndex = -1;
    // –ò—â–µ–º —Å –∫–æ–Ω—Ü–∞ (—á—Ç–æ–±—ã –∫–ª–∏–∫–∞—Ç—å –Ω–∞ –≤–µ—Ä—Ö–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç—ã)
    for (let i = State.trashItems.length - 1; i >= 0; i--) {
      if (State.trashItems[i].checkHit(x, y)) {
        hitIndex = i;
        break;
      }
    }

    if (hitIndex !== -1) {
      const item = State.trashItems[hitIndex];
      
      // –≠—Ñ—Ñ–µ–∫—Ç—ã
      AudioSys.trashSound();
      spawnParticles(item.x, item.y);
      showFloatText(item.x, item.y, "+10");
      
      // –£–¥–∞–ª–µ–Ω–∏–µ
      State.trashItems.splice(hitIndex, 1);
      
      // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
      const total = 30; // –ù–∞—á–∞–ª—å–Ω–æ–µ –∫–æ–ª-–≤–æ
      const current = State.trashItems.length;
      const progress = 1 - (current / total);
      
      State.targetPollution = Math.max(0, 1.0 - progress);
      
      // –ó–≤—É–∫ –ø—Ä–∏—Ä–æ–¥—ã, –µ—Å–ª–∏ –¥–æ—Å—Ç–∏–≥–ª–∏ —ç—Ç–∞–ø–∞
      if (Math.random() > 0.7 && progress > 0.3) {
        AudioSys.natureSound();
      }

      updateUI();
    }
  }
};

function spawnParticles(x, y) {
  for(let i=0; i<10; i++) {
    State.particles.push(new Particle(x, y, '#fff'));
    State.particles.push(new Particle(x, y, '#4effbf')); // –ó–µ–ª–µ–Ω—ã–µ –∏—Å–∫—Ä—ã
  }
}

function showFloatText(x, y, txt) {
  const el = document.createElement('div');
  el.className = 'float-text';
  el.style.left = x + 'px';
  el.style.top = y + 'px';
  el.innerText = txt;
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 1000);
}

function updateUI() {
  const total = 30;
  const current = State.trashItems.length;
  const pct = Math.floor((1 - current/total) * 100);
  
  document.getElementById('fill').style.width = pct + '%';
  document.getElementById('percent').innerText = pct + '%';
}

function endGame() {
  State.playing = false;
  // –§–∏–Ω–∞–ª—å–Ω—ã–π –∞–∫–∫–æ—Ä–¥
  AudioSys.natureSound();
  AudioSys.playTone(400, 'sine', 2, 0.1);
  AudioSys.playTone(600, 'sine', 2, 0.1);
  
  // –ö–æ–Ω—Ñ–µ—Ç—Ç–∏ –∏–∑ –∂–∏–≤–æ—Ç–Ω—ã—Ö
  for(let i=0; i<10; i++) State.animals.push(new Animal());

  setTimeout(() => {
    document.getElementById('endScreen').classList.remove('hidden');
    document.getElementById('ui').style.opacity = 0;
  }, 2000);
}

// --- SETUP ---
function resize() {
  DPR = window.devicePixelRatio || 1;
  W = window.innerWidth;
  H = window.innerHeight;
  canvas.width = W * DPR;
  canvas.height = H * DPR;
  ctx.scale(DPR, DPR);
}
window.addEventListener('resize', resize);
resize();

// Mouse / Touch
canvas.addEventListener('pointerdown', (e) => {
  Game.onClick(e.clientX, e.clientY);
});
window.addEventListener('pointermove', (e) => {
  const c = document.getElementById('cursor');
  c.style.left = e.clientX + 'px';
  c.style.top = e.clientY + 'px';
  
  // Hover effect
  const mx = e.clientX, my = e.clientY;
  let hover = false;
  State.trashItems.forEach(t => {
    t.hover = t.checkHit(mx, my);
    if(t.hover) hover = true;
  });
  c.style.borderColor = hover ? '#ff6b6b' : 'rgba(255,255,255,0.5)';
  c.style.transform = hover ? 'translate(-50%, -50%) scale(1.5)' : 'translate(-50%, -50%) scale(1)';
  canvas.style.cursor = hover ? 'pointer' : 'default';
});

// –ó–∞–ø—É—Å–∫ —Ü–∏–∫–ª–∞
requestAnimationFrame(loop);

</script>
</body>
</html>
